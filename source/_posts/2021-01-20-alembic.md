---
title: Alembic
toc: false
date: 2021-01-20 13:15:00
description: 数据库迁移工具
tags:
- Python
---

Alembic是一个轻量级的数据库迁移工具，可与SQLAlchemy Database Toolkit for Python一起使用。

Alembic使用SQLAlchemy作为底层引擎。

## 安装

```bash
$ pip install alembic
```

## 使用

**初始化**

```bash
$ alembic init alembic
```

将会在当前目录下生成一个alembic的目录，像这样：

```
|--alembic\
|  |--versions\
|  |--env.py
|  |--README
|  |--script.py.mako
|--alembic.ini
```

**创建迁移脚本**

```bash
$ alembic revision -m "first revision"
```

执行后，将会在versions下创建一个python脚本: 95cd2fc4eacd_first_revision.py

在生成的对应版本的脚本中实现upgrade和downgrade

```python
def upgrade():
    op.create_table("user",
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("full_name", sa.String(), nullable=True),
        sa.Column("email", sa.String(), nullable=True),
        sa.Column("hashed_password", sa.String(), nullable=True),
        sa.Column("is_active", sa.Boolean(), nullable=True),
        sa.Column("is_superuser", sa.Boolean(), nullable=True),
        sa.PrimaryKeyConstraint("id")
    )
    op.create_index(op.f("ix_user_email"), "user", ["email"], unique=True)
    op.create_index(op.f("ix_user_full_name"), "user", ["full_name"], unique=False)
    op.create_index(op.f("ix_user_id"), "user", ["id"], unique=False)
```

在upgrade中创建了用户表以及对应的索引，则需要在downgrade中删除对应的表和索引

```python
def downgrade():
    op.drop_index(op.f("ix_user_id"), table_name="user")
    op.drop_index(op.f("ix_user_full_name"), table_name="user")
    op.drop_index(op.f("ix_user_email"), table_name="user")
    op.drop_table("user")
```

由于是单独测试alembic, 需要在alembic.ini中修改数据库连接。

```ini
sqlalchemy.url = postgresql://postgres:TopLinker0510@localhost/test
```

**执行**

```bash
$ alembic upgrade head
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> 95cd2fc4eacd, first revision
```

## Reference

- https://alembic.sqlalchemy.org/

